# ルーム情報
type Room {
  roomId: ID!
  roomCode: String!
  hostId: ID!
  state: GameState!
  topic: String
  topicsPool: [String!]!      # 未使用のお題リスト
  usedTopics: [String!]!      # 使用済みのお題リスト
  lastJudgeResult: Boolean
  judgedAt: AWSDateTime
  comments: [String!]          # ニコニコ風コメントリスト（オプショナル）
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
  players: [Player!]!
  answers: [Answer!]!
}

# ゲーム状態
enum GameState {
  WAITING    # プレイヤー待機中
  ANSWERING  # 回答入力中
  JUDGING    # 判定中
}

# プレイヤー情報
type Player {
  playerId: ID!
  roomId: ID!
  name: String!
  role: PlayerRole!
  connected: Boolean!
  joinedAt: AWSDateTime!
}

enum PlayerRole {
  HOST
  PLAYER
}

# 回答情報
type Answer {
  answerId: ID!
  roomId: ID!
  playerId: ID!
  playerName: String!
  answerType: AnswerType!
  textAnswer: String
  drawingData: String  # Base64エンコードされた画像
  submittedAt: AWSDateTime!
}

enum AnswerType {
  TEXT
  DRAWING
}

# 判定結果
type JudgeResult {
  roomId: ID!
  isMatch: Boolean!
  judgedAt: AWSDateTime!
}

# ===========================================
# Subscription用の型（全フィールドnullable）
# AppSyncのSubscription初期接続時にnullが返されるため必要
# ===========================================

type RoomSubscription {
  roomId: ID
  roomCode: String
  hostId: ID
  state: GameState
  topic: String
  topicsPool: [String]
  usedTopics: [String]
  lastJudgeResult: Boolean
  judgedAt: AWSDateTime
  comments: [String]
  createdAt: AWSDateTime
  updatedAt: AWSDateTime
  players: [PlayerSubscription]
  answers: [AnswerSubscription]
}

type PlayerSubscription {
  playerId: ID
  roomId: ID
  name: String
  role: PlayerRole
  connected: Boolean
  joinedAt: AWSDateTime
}

type AnswerSubscription {
  answerId: ID
  roomId: ID
  playerId: ID
  playerName: String
  answerType: AnswerType
  textAnswer: String
  drawingData: String
  submittedAt: AWSDateTime
}

type JudgeResultSubscription {
  roomId: ID
  isMatch: Boolean
  judgedAt: AWSDateTime
}

# Publish用のInput型
input PlayerInput {
  playerId: ID!
  roomId: ID!
  name: String!
  role: PlayerRole!
  connected: Boolean!
  joinedAt: AWSDateTime
}

input AnswerInput {
  answerId: ID!
  roomId: ID!
  playerId: ID!
  playerName: String!
  answerType: AnswerType!
  textAnswer: String
  drawingData: String
  submittedAt: AWSDateTime
}

type DeleteAllDataResponse {
  success: Boolean!
  message: String!
  deletedCounts: DeletedCounts!
}

type DeletedCounts {
  rooms: Int!
  players: Int!
  answers: Int!
}

# Mutations
type Mutation {
  # ルームを作成（ホスト用）
  createRoom(hostName: String!): Room!

  # ルームに参加（プレイヤー用）
  joinRoom(roomCode: String!, playerName: String!): Player!

  # ルームから退出
  leaveRoom(roomId: ID!, playerId: ID!): Boolean!

  # プレイヤーを追放（ホストのみ）
  kickPlayer(roomId: ID!, playerId: ID!, kickedPlayerId: ID!): Boolean!

  # ゲームを開始（ホストのみ）- お題プールを生成してゲーム開始
  startGame(roomId: ID!): Room!

  # 回答を提出
  submitAnswer(
    roomId: ID!
    playerId: ID!
    answerType: AnswerType!
    textAnswer: String
    drawingData: String
  ): Answer!

  # 判定画面に遷移（ホストのみ）
  startJudging(roomId: ID!): Room!

  # 判定用コメントを非同期生成（ホストのみ）
  generateJudgingComments(roomId: ID!): JudgeResult!

  # 判定を実行（ホストのみ）
  judgeAnswers(roomId: ID!, isMatch: Boolean!): JudgeResult!

  # 次のラウンドへ（ホストのみ）
  nextRound(roomId: ID!): Room!

  # ゲームを終了（ホストのみ）
  endGame(roomId: ID!): Room!

  # 全データを削除（開発用）
  deleteAllData: DeleteAllDataResponse!

  # ===========================================
  # Subscription用のPublish Mutations（内部用）
  # これらはLambdaから呼び出されてSubscriptionをトリガーする
  # ===========================================

  # プレイヤー参加をPublish
  publishPlayerJoined(
    playerId: ID!
    roomId: ID!
    name: String!
    role: PlayerRole!
    connected: Boolean!
    joinedAt: AWSDateTime!
  ): PlayerSubscription!

  # ルーム更新をPublish
  publishRoomUpdated(
    roomId: ID!
    roomCode: String!
    hostId: ID!
    state: GameState!
    topic: String
    topicsPool: [String!]!
    usedTopics: [String!]!
    lastJudgeResult: Boolean
    judgedAt: AWSDateTime
    comments: [String!]
    createdAt: AWSDateTime!
    updatedAt: AWSDateTime!
    players: [PlayerInput!]!
    answers: [AnswerInput!]!
  ): RoomSubscription!

  # 回答提出をPublish
  publishAnswerSubmitted(
    answerId: ID!
    roomId: ID!
    playerId: ID!
    playerName: String!
    answerType: AnswerType!
    textAnswer: String
    drawingData: String
    submittedAt: AWSDateTime!
  ): AnswerSubscription!

  # 判定結果をPublish
  publishJudgeResult(
    roomId: ID!
    isMatch: Boolean!
    judgedAt: AWSDateTime!
  ): JudgeResultSubscription!
}

# Queries
type Query {
  # ルーム情報を取得
  getRoom(roomId: ID!): Room

  # ルームコードからルームを取得
  getRoomByCode(roomCode: String!): Room

  # プレイヤー一覧を取得
  listPlayers(roomId: ID!): [Player!]!

  # 回答一覧を取得
  listAnswers(roomId: ID!): [Answer!]!
}

# Subscriptions
type Subscription {
  # ルーム状態の変更を購読（ゲーム開始、判定、次ラウンド等）
  onRoomUpdated(roomId: ID!): RoomSubscription
    @aws_subscribe(mutations: ["publishRoomUpdated"])

  # プレイヤー参加を購読
  onPlayerJoined(roomId: ID!): PlayerSubscription
    @aws_subscribe(mutations: ["publishPlayerJoined"])

  # 回答提出を購読
  onAnswerSubmitted(roomId: ID!): AnswerSubscription
    @aws_subscribe(mutations: ["publishAnswerSubmitted"])

  # 判定結果を購読
  onJudgeResult(roomId: ID!): JudgeResultSubscription
    @aws_subscribe(mutations: ["publishJudgeResult"])
}

schema {
  query: Query
  mutation: Mutation
  subscription: Subscription
}
