AWSTemplateFormatVersion: '2010-09-09'
Description: 'AppSync backend for Mitsu Game'

Parameters:
  ProjectName:
    Type: String
    Default: mitsu-game
    Description: Project name

  DeployBucket:
    Type: String
    Description: S3 bucket containing deployment artifacts

  OpenAIApiKey:
    Type: String
    NoEcho: true
    Description: OpenAI API Key for topic and comment generation

Resources:
  # ===========================================
  # DynamoDB Tables
  # ===========================================

  # ルームテーブル
  RoomTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-rooms'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: roomId
          AttributeType: S
        - AttributeName: roomCode
          AttributeType: S
      KeySchema:
        - AttributeName: roomId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: roomCode-index
          KeySchema:
            - AttributeName: roomCode
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-rooms'

  # プレイヤーテーブル
  PlayerTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-players'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: playerId
          AttributeType: S
        - AttributeName: roomId
          AttributeType: S
      KeySchema:
        - AttributeName: playerId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: roomId-index
          KeySchema:
            - AttributeName: roomId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-players'

  # 回答テーブル
  AnswerTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-answers'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: answerId
          AttributeType: S
        - AttributeName: roomId
          AttributeType: S
      KeySchema:
        - AttributeName: answerId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: roomId-index
          KeySchema:
            - AttributeName: roomId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-answers'

  # ===========================================
  # Cognito Identity Pool（未認証アクセス用 - ユーザー登録不要）
  # ===========================================

  # Identity Pool - ユーザー登録不要で一時的なAWS認証情報を発行
  CognitoIdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName: !Sub '${ProjectName}-identity-pool'
      AllowUnauthenticatedIdentities: true  # 未認証アクセスを許可（登録不要）

  # 未認証ユーザー用のIAMロール
  CognitoUnauthRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-cognito-unauth-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: cognito-identity.amazonaws.com
            Action: 'sts:AssumeRoleWithWebIdentity'
            Condition:
              StringEquals:
                'cognito-identity.amazonaws.com:aud': !Ref CognitoIdentityPool
              ForAnyValue:StringLike:
                'cognito-identity.amazonaws.com:amr': unauthenticated
      Policies:
        - PolicyName: CognitoUnauthPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # AppSyncへのアクセスを許可
              - Effect: Allow
                Action:
                  - 'appsync:GraphQL'
                Resource:
                  - !Sub 'arn:aws:appsync:${AWS::Region}:${AWS::AccountId}:apis/${AppSyncApi.ApiId}/*'

  # Identity PoolとIAMロールの紐付け
  CognitoIdentityPoolRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref CognitoIdentityPool
      Roles:
        unauthenticated: !GetAtt CognitoUnauthRole.Arn

  # ===========================================
  # AppSync API
  # ===========================================

  # AppSync API（IAM認証を使用 - Cognito Identity Poolと連携）
  AppSyncApi:
    Type: AWS::AppSync::GraphQLApi
    Properties:
      Name: !Sub '${ProjectName}-api'
      AuthenticationType: AWS_IAM
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-api'

  # GraphQL Schema
  AppSyncSchema:
    Type: AWS::AppSync::GraphQLSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      DefinitionS3Location: !Sub 's3://${DeployBucket}/schema.graphql'

  # ===========================================
  # Data Sources
  # ===========================================

  # DynamoDB Data Sources
  RoomDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: RoomTable
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      DynamoDBConfig:
        TableName: !Ref RoomTable
        AwsRegion: !Ref AWS::Region

  PlayerDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: PlayerTable
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      DynamoDBConfig:
        TableName: !Ref PlayerTable
        AwsRegion: !Ref AWS::Region

  AnswerDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: AnswerTable
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      DynamoDBConfig:
        TableName: !Ref AnswerTable
        AwsRegion: !Ref AWS::Region

  # Lambda Data Source
  LambdaDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: LambdaResolver
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt ResolverFunction.Arn

  # ===========================================
  # IAM Roles
  # ===========================================

  # IAM Role for AppSync
  AppSyncServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-appsync-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: AppSyncLambdaInvokePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'lambda:InvokeFunction'
                Resource: !GetAtt ResolverFunction.Arn
              - Effect: Allow
                Action:
                  - 'dynamodb:*'
                Resource: '*'

  # Lambda Execution Role
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
        - 'arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess'

  # ===========================================
  # Lambda Function
  # ===========================================

  # Lambda Resolver Function (Go)
  ResolverFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-resolver'
      Runtime: provided.al2023
      Handler: bootstrap
      Architectures:
        - arm64
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !Ref DeployBucket
        S3Key: lambda-function.zip
      Environment:
        Variables:
          ROOM_TABLE: !Ref RoomTable
          PLAYER_TABLE: !Ref PlayerTable
          ANSWER_TABLE: !Ref AnswerTable
          OPENAI_API_KEY: !Ref OpenAIApiKey
      Timeout: 30

  # ===========================================
  # Resolvers - Mutations
  # ===========================================

  CreateRoomResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: createRoom
      DataSourceName: !GetAtt LambdaDataSource.Name

  JoinRoomResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: joinRoom
      DataSourceName: !GetAtt LambdaDataSource.Name

  LeaveRoomResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: leaveRoom
      DataSourceName: !GetAtt LambdaDataSource.Name

  KickPlayerResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: kickPlayer
      DataSourceName: !GetAtt LambdaDataSource.Name

  StartGameResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: startGame
      DataSourceName: !GetAtt LambdaDataSource.Name

  SubmitAnswerResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: submitAnswer
      DataSourceName: !GetAtt LambdaDataSource.Name

  StartJudgingResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: startJudging
      DataSourceName: !GetAtt LambdaDataSource.Name

  GenerateJudgingCommentsResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: generateJudgingComments
      DataSourceName: !GetAtt LambdaDataSource.Name

  JudgeAnswersResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: judgeAnswers
      DataSourceName: !GetAtt LambdaDataSource.Name

  NextRoundResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: nextRound
      DataSourceName: !GetAtt LambdaDataSource.Name

  EndGameResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: endGame
      DataSourceName: !GetAtt LambdaDataSource.Name

  DeleteAllDataResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: deleteAllData
      DataSourceName: !GetAtt LambdaDataSource.Name

  # ===========================================
  # Resolvers - Queries
  # ===========================================

  GetRoomResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: getRoom
      DataSourceName: !GetAtt LambdaDataSource.Name

  GetRoomByCodeResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: getRoomByCode
      DataSourceName: !GetAtt LambdaDataSource.Name

  ListPlayersResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listPlayers
      DataSourceName: !GetAtt LambdaDataSource.Name

  ListAnswersResolver:
    Type: AWS::AppSync::Resolver
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listAnswers
      DataSourceName: !GetAtt LambdaDataSource.Name


# ===========================================
# Outputs
# ===========================================

Outputs:
  GraphQLApiEndpoint:
    Description: GraphQL API Endpoint
    Value: !GetAtt AppSyncApi.GraphQLUrl
    Export:
      Name: !Sub '${AWS::StackName}-GraphQLEndpoint'

  GraphQLApiId:
    Description: GraphQL API ID
    Value: !GetAtt AppSyncApi.ApiId
    Export:
      Name: !Sub '${AWS::StackName}-GraphQLApiId'

  IdentityPoolId:
    Description: Cognito Identity Pool ID
    Value: !Ref CognitoIdentityPool
    Export:
      Name: !Sub '${AWS::StackName}-IdentityPoolId'

  RoomTableName:
    Description: Room Table Name
    Value: !Ref RoomTable

  PlayerTableName:
    Description: Player Table Name
    Value: !Ref PlayerTable

  AnswerTableName:
    Description: Answer Table Name
    Value: !Ref AnswerTable
